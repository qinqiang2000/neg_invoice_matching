# 负数发票匹配系统核心可行性验证测试计划

## 背景
根据技术文档的核心主张，本方案需要验证以下关键指标：
- **匹配率 >93%** - 贪婪算法通过优先消耗小额剩余提高匹配成功率
- **碎片率 8-12%** - 系统自动维持健康的碎片水平
- **性能 P99 <70ms** - 批量处理延迟控制
- **碎片生命周期** - 小额剩余3-30天内自动清零
- **支持千万级数据** - 单机PostgreSQL即可支撑

## 现有测试覆盖
- ✅ test_basic_matching.py - 基础功能测试（小规模数据）
- ✅ test_edge_cases.py - 边界情况测试（特殊场景）
- ✅ test_improvements.py - 改进功能测试（分组优化、监控、流式处理）

## 缺失的关键测试

### 1. test_performance_scale.py - 大规模性能测试 ⭐️
**验证目标**: P99延迟<70ms，支持千万级数据
- 生成100万条蓝票行数据（模拟生产环境）
- 批量处理1000-10000个负数发票
- 测量查询性能、匹配性能、事务提交性能
- 验证索引效率（部分索引 vs 全量索引）
- 内存使用监控
- 生成性能测试报告

**关键指标**：
- 数据规模：100万、500万、1000万蓝票行
- 并发负数发票：100、1000、10000个
- 响应时间分布：P50、P90、P95、P99
- 内存峰值使用
- 数据库查询次数和耗时分布

### 2. test_fragment_lifecycle.py - 碎片生命周期测试
**验证目标**: 小额剩余3-30天内自动清零，碎片率维持8-12%
- 模拟30天的连续运行
- 跟踪不同金额区间的剩余生命周期
- 验证贪婪算法优先消耗小额剩余
- 统计碎片清零时间分布
- 验证文档表格数据：
  - 50元剩余：平均1.2次使用，3天清零
  - 100元剩余：平均1.8次使用，5天清零
  - 500元剩余：平均4.5次使用，15天清零
  - 1000元剩余：平均8.3次使用，30天清零

### 3. test_concurrent_stress.py - 并发压力测试
**验证目标**: 高并发下的系统稳定性和数据一致性
- 模拟100个并发请求
- 测试乐观锁防止超卖机制
- 验证事务隔离级别
- 测试连接池性能
- 死锁检测和恢复
- 并发冲突统计

### 4. test_algorithm_comparison.py - 算法对比测试
**验证目标**: 贪婪算法匹配率>93%，优于其他策略
- 实现对比算法：
  - 随机选择策略
  - 最大额优先策略
  - 最少蓝票数策略（原方案）
  - 最佳适配策略（Best Fit）
- 使用相同数据集对比：
  - 匹配成功率
  - 碎片产生率
  - 执行时间
  - 蓝票使用效率
- 生成对比报告和可视化图表

### 5. test_long_running_simulation.py - 长期运行模拟测试
**验证目标**: 系统长期健康运行，碎片率保持稳定
- 模拟7天×24小时连续运行
- 每小时产生新的蓝票和负数发票
- 监控关键指标变化趋势：
  - 匹配成功率
  - 碎片率
  - 平均响应时间
  - 数据库膨胀率
- 生成健康度报告和趋势图

## 实施优先级

1. **test_performance_scale.py** （优先级：最高）
   - 最直接验证生产可行性
   - 提供性能基准数据
   - 确定系统容量上限

2. **test_algorithm_comparison.py** （优先级：高）
   - 证明贪婪算法核心优势
   - 提供算法选择依据
   - 验证匹配率>93%的主张

3. **test_fragment_lifecycle.py** （优先级：中）
   - 验证自清理特性
   - 证明碎片率可控
   - 验证长期健康运行

4. **test_concurrent_stress.py** （优先级：中）
   - 确保生产环境稳定性
   - 验证并发安全机制
   - 测试系统极限

5. **test_long_running_simulation.py** （优先级：低）
   - 长期稳定性验证
   - 趋势分析
   - 预测潜在问题

## 测试环境要求

### 硬件配置
- CPU：4核8线程
- 内存：16GB
- 存储：300GB SSD
- 数据库：PostgreSQL 17.6

### 软件依赖
- Python 3.8+
- PostgreSQL 17.6
- 必要的Python包：
  - psycopg2
  - numpy
  - tqdm
  - matplotlib（报告生成）
  - pandas（数据分析）

## 预期成果

1. **性能基准报告**
   - 不同数据规模下的性能指标
   - 瓶颈分析和优化建议
   - 容量规划参考

2. **算法对比报告**
   - 各算法优劣对比
   - 贪婪算法优势量化
   - 场景适用性分析

3. **系统健康度报告**
   - 长期运行稳定性评估
   - 碎片控制效果验证
   - 运维参考指标

4. **可行性结论**
   - 是否满足技术文档声称的各项指标
   - 生产环境部署建议
   - 潜在风险和应对方案